<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>扩展概述 :: 我的文档</title>
    <meta name="generator" content="Antora 3.1.10">
    <link rel="stylesheet" href="../../../_/css/site.css">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="../../..">我的文档</a>
      <button class="navbar-burger" aria-controls="topbar-nav" aria-expanded="false" aria-label="Toggle main menu">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="#">Home</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Products</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Product A</a>
            <a class="navbar-item" href="#">Product B</a>
            <a class="navbar-item" href="#">Product C</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Services</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="#">Service A</a>
            <a class="navbar-item" href="#">Service B</a>
            <a class="navbar-item" href="#">Service C</a>
          </div>
        </div>
        <div class="navbar-item">
          <span class="control">
            <a class="button is-primary" href="#">Download</a>
          </span>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="docs-neutralino-api" data-version="0.0.1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <button class="nav-menu-toggle" aria-label="Toggle expand/collapse all" style="display: none"></button>
    <h3 class="title"><a href="../index.html">NeutralinoJS 文档</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">开始</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../index.html">介绍</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../getting-started/your-first-neutralinojs-app.html">你的第一个应用</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../getting-started/using-frontend-libraries.html">使用前端库</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">原生API</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/overview.html">API概述</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/app.html">应用程序</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/clipboard.html">剪贴板</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/computer.html">硬件</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/custom.html">自定义</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/debug.html">调试</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/events.html">事件</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/extensions.html">拓展</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/filesystem.html">文件系统</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/init.html">初始化</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/os.html">操作系统</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/storage.html">存储</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/updater.html">更新</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/window.html">窗口</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/resources.html">资源</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/error-codes.html">错误代码</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../api/global-variables.html">全局变量</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">命令行</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../cli/neu-cli.html">neu CLI</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../cli/internal-cli-arguments.html">内部 CLI 参数</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">配置</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuration/neutralino.config.json.html">neutralino.config.json</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuration/project-structure.html">项目结构</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuration/modes.html">模式</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">如何</span>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="extensions-overview.html">扩展概述</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="auto-updater.html">自动更新</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">发布</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../distribution/overview.html">发布概述</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">贡献</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../contributing/framework-developer-guide.html">框架开发者指南</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../contributing/architecture.html">架构</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../contributing/security.html">安全</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../contributing/code-style-guide.html">编码风格指南</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../contributing/developer-support.html">开发者支持</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../contributing/committers.html">提交者</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../contributing/frequently-asked-questions.html">常见问题解答</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../contributing/about-neutralinojs.html">关于Neutralinojs</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">更新日志</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="https://neutralino.js.org/docs/release-notes/framework">Framework</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="https://neutralino.js.org/docs/release-notes/cli">CLI</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="https://neutralino.js.org/docs/release-notes/client-library">Client Library</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">NeutralinoJS 文档</span>
    <span class="version">0.0.1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <div class="title"><a href="../index.html">NeutralinoJS 文档</a></div>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">0.0.1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">NeutralinoJS 文档</a></li>
    <li>如何</li>
    <li><a href="extensions-overview.html">扩展概述</a></li>
  </ul>
</nav>
<div class="edit-this-page"><a href="https://github.com/qq253498229/docs-neutralino-api/edit/master/modules/ROOT/pages/how-to/extensions-overview.adoc">Edit this Page</a></div>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="目录" data-levels="3">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">扩展概述</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Neutralino框架提供了一个原生API，允许用户执行各种操作系统级别的操作，如访问文件系统、执行命令和显示对话框。尽管用户在构建应用程序时可能需要额外的原生API，例如数据库连接器，但如果将所有这些都添加到核心中，会使框架变得臃肿。因此，框架提供了一个基于WebSocket的扩展系统，允许用户在无需从源代码构建框架的情况下扩展Neutralinojs API。</p>
</div>
<div class="paragraph">
<p>扩展API提供了使用任何编程语言编写应用程序自定义后端代码的灵活性。此外，扩展API允许你将Neutralinojs进程包含在任何源文件中。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="defining-the-extensions"><a class="anchor" href="#defining-the-extensions"></a>定义扩展</h2>
<div class="sectionbody">
<div class="paragraph">
<p>首先，你需要在 <code>neutralinojs.config.json</code> 中定义你使用的扩展，结构如下。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">"extensions": [
    {
        "id": "js.neutralino.sampleextension",
        "commandLinux": "${NL_PATH}/extensions/binary/linux/ext_bin",
        "commandDarwin": "${NL_PATH}/extensions/binary/mac/ext_bin",
        "commandWindows": "${NL_PATH}/extensions/binary/win/ext_bin.exe"
    },
    {
        "id": "js.neutralino.binaryextension",
        "command": "node ${NL_PATH}/extensions/binary/main.js",
    }
]</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>id</code> 字符串：用于标识每个扩展的唯一键。此id不能包含除字母、数字和句点之外的任何字符。</p>
</li>
<li>
<p><code>command</code> 字符串（可选）：启动扩展的跨平台命令。例如：<code>node ${NL_PATH}/extensions/binary/main.js</code>将在每个平台上工作。</p>
</li>
<li>
<p><code>commandLinux</code> 字符串（可选）：Linux上的扩展启动命令。</p>
</li>
<li>
<p><code>commandDarwin</code> 字符串（可选）：macOS上的扩展启动命令。</p>
</li>
<li>
<p><code>commandWindows</code> 字符串（可选）：Windows上的扩展启动命令。</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="enable-the-extensions-feature"><a class="anchor" href="#enable-the-extensions-feature"></a>启用扩展功能</h2>
<div class="sectionbody">
<div class="paragraph">
<p>扩展API默认是禁用的。通过在应用配置中添加以下设置来启用扩展。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">"enableExtensions": true</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="connecting-an-extension-with-neutralinojs"><a class="anchor" href="#connecting-an-extension-with-neutralinojs"></a>将扩展与Neutralinojs连接</h2>
<div class="sectionbody">
<div class="paragraph">
<p>正如你已经注意到的，扩展只是一个单独的进程。Neutralinojs在框架启动过程中开始生成扩展实例，并通过标准输入流发送以下JSON对象来初始化每个扩展进程：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">{
  "nlPort": "",
  "nlToken": "",
  "nlConnectToken": "",
  "nlExtensionId": ""
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>上述JSON属性包含的连接信息如下：</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>nlPort</code>：Neutralinojs服务器的端口。</p>
</li>
<li>
<p><code>nlToken</code>：使用原生API的访问令牌。</p>
</li>
<li>
<p><code>nlConnectToken</code>：扩展在WebSocket连接初始化期间应发送的令牌。</p>
</li>
<li>
<p><code>nlExtensionId</code>：扩展标识符。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>现在，你可以使用上述详细信息与Neutralinojs服务器建立连接。使用以下WebSocket URL来初始化一个新的WebSocket连接。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">ws://localhost:{port}?extensionId={extensionId}&amp;connectToken={connectToken}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sending-a-message-from-app-to-an-extension"><a class="anchor" href="#sending-a-message-from-app-to-an-extension"></a>从应用向扩展发送消息</h2>
<div class="sectionbody">
<div class="paragraph">
<p>扩展API使用基于事件的消息传递协议。每条消息使用以下JSON结构。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">{
  "event": "&lt;event_name&gt;",
  "data": {}
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>使用内置的扩展API向任何扩展发送消息，如下所示。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">let extension = 'js.neutralino.sampleextension';
let event = 'helloExtension';
let data = {
  testValue: 10,
};

await Neutralino.extensions.dispatch(extension, event, data);</code></pre>
</div>
</div>
<div class="paragraph">
<p>上述代码片段向<code>js.neutralino.sampleextension</code>扩展实例发送消息。你可以随时使用<code>dispatch</code>函数向扩展发送消息。如果你在扩展与主进程连接之前发送消息，Neutralinojs客户端库会将消息排队，并在目标扩展的连接建立时发送。换句话说，当你向扩展发送消息时，你无需担心扩展的状态。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="sending-a-message-from-the-extension-to-app"><a class="anchor" href="#sending-a-message-from-the-extension-to-app"></a>从扩展向应用发送消息</h2>
<div class="sectionbody">
<div class="paragraph">
<p>当你将扩展与Neutralinojs主进程连接时，你可以通过直接向Neutralinojs进程发送WebSocket消息来调用原生API。Neutralinojs服务器根据以下格式处理消息。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">{
  "id": "&lt;id&gt;",
  "method": "&lt;method&gt;",
  "accessToken": "&lt;token&gt;",
  "data": {}
}</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><code>id</code> 字符串：<a href="https://en.wikipedia.org/wiki/Universally_unique_identifier">UUID</a> v4字符串。</p>
</li>
<li>
<p><code>method</code> 字符串：原生方法名。例如：<code>window.setTitle</code>。</p>
</li>
<li>
<p><code>accessToken</code> 字符串：由Neutralinojs服务器生成的访问令牌。</p>
</li>
<li>
<p><code>data</code> 对象（可选）：原生方法的参数。</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>你可以调用<code>app.broadcast</code>原生方法向所有应用实例发送消息。在应用代码中使用<code>events.on</code>注册回调来接收扩展进程发送的消息。</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="terminating-an-extension-instance"><a class="anchor" href="#terminating-an-extension-instance"></a>终止扩展实例</h2>
<div class="sectionbody">
<div class="paragraph">
<p>当Neutralino退出时，它不会向所有扩展实例发送终止信号。因此，当基于WebSocket的IPC（进程间通信）关闭时，有必要停止扩展进程。以下Node.js扩展代码展示了如何做到这一点：</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">const fs = require('fs');
const process = require('process');
const WS = require('websocket').w3cwebsocket;
const { v4: uuidv4 } = require('uuid');
const chalk = require('chalk');

// Obtain required params to start a WS connection from stdIn.
const processInput = JSON.parse(fs.readFileSync(process.stdin.fd, 'utf-8'));
const NL_PORT = processInput.nlPort;
const NL_TOKEN = processInput.nlToken;
const NL_CTOKEN = processInput.nlConnectToken;
const NL_EXTID = processInput.nlExtensionId;

const client = new WS(
  `ws://localhost:${NL_PORT}?extensionId=${NL_EXTID}&amp;connectToken=${NL_CTOKEN}`
);

client.onerror = () =&gt; log("Connection error!", "ERROR");
client.onopen = () =&gt; log("Connected");
client.onclose = () =&gt; process.exit();

client.onmessage = (e) =&gt; {
  const { event, data } = JSON.parse(e.data);

  if (event === "eventToExtension") {
    log(data);

    client.send(
      JSON.stringify({
        id: uuidv4(),
        method: "app.broadcast",
        accessToken: NL_TOKEN,
        data: { event: "eventFromExtension", data: "Hello app!" },
      })
    );
  }
};

function log(message, type = "INFO") {
  const logLine = `[${NL_EXTID}]: ${chalk[
    type === "INFO" ? "green" : "red"
  ](type)} ${message}`;
  console[type === "INFO" ? "log" : "error"](logLine);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>这段代码实现了一个简单的Neutralinojs Node.js扩展，它与Neutralinojs服务器建立WebSocket连接，并处理来自服务器的传入消息。当它从服务器接收到特定事件时，它还会使用client.send方法向服务器发送消息。</p>
</div>
<div class="paragraph">
<p>有关如何终止扩展实例的更多信息，你可以参考示例扩展源码。
<a href="https://github.com/neutralinojs/neutralinojs/tree/main/bin/extensions/sampleextension" class="bare">https://github.com/neutralinojs/neutralinojs/tree/main/bin/extensions/sampleextension</a></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="using-neutralinojs-from-your-source-files"><a class="anchor" href="#using-neutralinojs-from-your-source-files"></a>在你的源文件中使用Neutralinojs</h2>
<div class="sectionbody">
<div class="paragraph">
<p>上述方法可以帮助你使用自定义后端代码扩展Neutralinojs API。Neutralinojs进程可以生成多个扩展作为子进程，并使用内部消息传递协议进行通信。另一方面，你也可以从自己的进程中生成Neutralinojs进程，并使用相同的消息传递协议进行通信。使用这种方法，你可以用任何后端语言编写Neutralinojs应用。</p>
</div>
<div class="paragraph">
<p>通过将配置设置如下，你可以获取Neutralinojs进程的认证详细信息。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">"exportAuthInfo": true</code></pre>
</div>
</div>
<div class="paragraph">
<p>上述设置将认证详细信息导出到 <code>${NL_PATH}/.tmp/auth_info.json</code>，格式如下。</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-javascript hljs" data-lang="javascript">{
  "nlPort": "&lt;port&gt;",
  "nlToken": "&lt;token&gt;",
  "nlConnectToken": "&lt;connect_token&gt;"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>使用扩展API与Neutralinojs进程建立连接，就像通常使用你在应用配置文件中使用的扩展标识符一样。</p>
</div>
</div>
</div>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>This page was built using the Antora default UI.</p>
  <p>The source code for this UI is licensed under the terms of the MPL-2.0 license.</p>
</footer>
<script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
